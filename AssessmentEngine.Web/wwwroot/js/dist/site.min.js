var AssessmentEngine;(AssessmentEngine=AssessmentEngine||{}).Constants={eftImages:{three:"/img/eft/3.jpg",two:"/img/eft/2.jpg",one:"/img/eft/1.jpg",cogLoadInstructions:"/img/eft/CogLoad_Instructions.jpg",endScreen:"/img/eft/EndScreen.jpg",enhanceCogLoadInstructions:"/img/eft/Enhance_CogLoad_Instructions.jpg",enhanceNoLoadInstructions:"/img/eft/Enhance_NoLoad_Instructions.jpg",fixationCross:"/img/eft/Fix_Cross.jpg",intro:"/img/eft/Intro.jpg",negRate:"/img/eft/NEG_Rate.jpg",numberRecallInstructions:"/img/eft/Number_Recall_Instructions.jpg",posRate:"/img/eft/POS_Rate.jpg",suppressCogLoadInstructions:"/img/eft/Suppress_CogLoad_Instructions.jpg",suppressNoLoadInstructions:"/img/eft/Suppress_NoLoad_Instructions.jpg",viewCogLoadInstructions:"/img/eft/View_CogLoad_Instructions.jpg",viewNoLoadInstructions:"/img/eft/View_NoLoad_Instructions.jpg",ep1Photos:["/img/eft/IAPS_Pos_1.jpg","/img/eft/IAPS_Pos_2.jpg","/img/eft/IAPS_Pos_3.jpg","/img/eft/IAPS_Pos_4.jpg","/img/eft/IAPS_Pos_5.jpg"],en1Photos:["/img/eft/IAPS_Neg_1.jpg","/img/eft/IAPS_Neg_2.jpg","/img/eft/IAPS_Neg_3.jpg","/img/eft/IAPS_Neg_4.jpg","/img/eft/IAPS_Neg_5.jpg"],sp1Photos:["/img/eft/IAPS_Pos_6.jpg","/img/eft/IAPS_Pos_7.jpg","/img/eft/IAPS_Pos_8.jpg","/img/eft/IAPS_Pos_9.jpg","/img/eft/IAPS_Pos_10.jpg"],sn1Photos:["/img/eft/IAPS_Neg_6.jpg","/img/eft/IAPS_Neg_7.jpg","/img/eft/IAPS_Neg_8.jpg","/img/eft/IAPS_Neg_9.jpg","/img/eft/IAPS_Neg_10.jpg"],vp1Photos:["/img/eft/IAPS_Pos_11.jpg","/img/eft/IAPS_Pos_12.jpg","/img/eft/IAPS_Pos_13.jpg","/img/eft/IAPS_Pos_14.jpg","/img/eft/IAPS_Pos_15.jpg"],vn1Photos:["/img/eft/IAPS_Neg_11.jpg","/img/eft/IAPS_Neg_12.jpg","/img/eft/IAPS_Neg_13.jpg","/img/eft/IAPS_Neg_14.jpg","/img/eft/IAPS_Neg_15.jpg"],ep2Photos:["/img/eft/IAPS_Pos_16.jpg","/img/eft/IAPS_Pos_17.jpg","/img/eft/IAPS_Pos_18.jpg","/img/eft/IAPS_Pos_19.jpg","/img/eft/IAPS_Pos_20.jpg"],en2Photos:["/img/eft/IAPS_Neg_16.jpg","/img/eft/IAPS_Neg_17.jpg","/img/eft/IAPS_Neg_18.jpg","/img/eft/IAPS_Neg_19.jpg","/img/eft/IAPS_Neg_20.jpg"],sp2Photos:["/img/eft/IAPS_Pos_21.jpg","/img/eft/IAPS_Pos_22.jpg","/img/eft/IAPS_Pos_23.jpg","/img/eft/IAPS_Pos_24.jpg","/img/eft/IAPS_Pos_25.jpg"],sn2Photos:["/img/eft/IAPS_Neg_21.jpg","/img/eft/IAPS_Neg_22.jpg","/img/eft/IAPS_Neg_23.jpg","/img/eft/IAPS_Neg_24.jpg","/img/eft/IAPS_Neg_25.jpg"],vp2Photos:["/img/eft/IAPS_Pos_26.jpg","/img/eft/IAPS_Pos_27.jpg","/img/eft/IAPS_Pos_28.jpg","/img/eft/IAPS_Pos_29.jpg","/img/eft/IAPS_Pos_30.jpg"],vn2Photos:["/img/eft/IAPS_Neg_26.jpg","/img/eft/IAPS_Neg_27.jpg","/img/eft/IAPS_Neg_28.jpg","/img/eft/IAPS_Neg_29.jpg","/img/eft/IAPS_Neg_30.jpg"],practicePosPhotos:["/img/eft/IAPS_Pos_Prac1.jpg","/img/eft/IAPS_Pos_Prac2.jpg","/img/eft/IAPS_Pos_Prac3.jpg","/img/eft/IAPS_Pos_Prac4.jpg","/img/eft/IAPS_Pos_Prac5.jpg","/img/eft/IAPS_Pos_Prac6.jpg"],practiceNegPhotos:["/img/eft/IAPS_Neg_Prac1.jpg","/img/eft/IAPS_Neg_Prac2.jpg","/img/eft/IAPS_Neg_Prac3.jpg","/img/eft/IAPS_Neg_Prac4.jpg","/img/eft/IAPS_Neg_Prac5.jpg","/img/eft/IAPS_Neg_Prac6.jpg"]},blockTypes:{unknown:0,EP1:1,EP2:2,EN1:3,EN2:4,SP1:5,SP2:6,SN1:7,SN2:8,VP1:9,VP2:10,VN1:11,VN2:12},blockDateTypes:{unknown:0,startTaskDateTime:1,endTaskDateTime:2,taskCompleteDateTime:3}},(AssessmentEngine=AssessmentEngine||{}).HttpService={},AssessmentEngine.HttpService.handleError=function(e){const t="Unexpected error see console for details";$("#ajaxAlert").length>0?AssessmentEngine.Utility.alertMsg("#ajaxAlert","danger",t):alert(t),console.error(e)},AssessmentEngine.HttpService.post=function(e,t){$.ajax({url:e,success:t,method:"POST",error:this.handleError})},AssessmentEngine.HttpService.postData=function(e,t,s){$.ajax({url:e,success:s,data:t,method:"POST",error:this.handleError})},AssessmentEngine.HttpService.get=function(e,t,s){$.ajax({url:e,success:t,method:"GET",cache:s||!1,error:this.handleError})},(AssessmentEngine=window.AssessmentEngine||{}).AjaxForm=function(e){this.sel=e.sel,this.$form=$(this.sel),this.action=this.$form.action},AssessmentEngine.AjaxForm.prototype.isValid=function(){return this.$form.validate(),this.$form.valid()},AssessmentEngine.AjaxForm.prototype.serialize=function(){const e={};return this.$form.serializeArray().forEach(t=>e[t.name]=t.value),e},AssessmentEngine.AjaxForm.prototype.submit=function(e,t){this.isValid()&&AssessmentEngine.HttpService.postData(this.$form.attr("action"),e,t)},(AssessmentEngine=window.AssessmentEngine||{}).Utility={},AssessmentEngine.Utility.toggleLoadingSpinner=function(){const e=$("#viewLoading"),t=$("#viewContainer");e.is(":visible")?(e.hide(),t.show()):(t.hide(),e.show())},AssessmentEngine.Utility.alertMsg=function(e,t,s){const n=$(e);if(0===n.lengh||!t||!s)return;const i='<div class="alert alert-__type__ alert-dismissible fade show" role="alert">\n            __text__\n            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n            </button>\n        </div>'.replace("__type__",t).replace("__text__",s);n.html(i)},AssessmentEngine.Utility.formatDate=function(e){return e?new Date(e).toLocaleString().replace(",",""):""},AssessmentEngine.Utility.buildSortMetadata=function(e){const t={};let s=[];return e&&e[0]&&(s=Object.keys(e[0])),s.forEach(e=>{t[e]=1}),{sortOrders:t,columns:s}},AssessmentEngine.Utility.sortGridData=function(e,t,s){let n=s[t]||1,i=e;return t&&(i=this.sortArray(e,t,n)),i},AssessmentEngine.Utility.isShortDate=e=>{if("boolean"==typeof e)return!1;const t=/^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/,s=e.toString().split(" ");if(s&&s[0]){const e=s[0].match(t);return e&&e.length>0}return!1},AssessmentEngine.Utility.sortArray=function(e,t,s){return e.slice().sort((e,n)=>(e=e[t],n=n[t],(this.isShortDate(e)||this.isShortDate(n))&&(e=new Date(e),n=new Date(n)),"string"==typeof e&&(e=e.toLowerCase()),"string"==typeof n&&(n=n.toLowerCase()),(e===n?0:e>n?1:-1)*s))},(AssessmentEngine=AssessmentEngine||{}).EftImageBuilder={},AssessmentEngine.EftImageBuilder.build=function(e){const t=AssessmentEngine.Constants.eftImages,s={intro:t.intro,three:t.three,two:t.two,one:t.one,endScreen:t.endScreen,fixationCross:t.fixationCross},n=()=>{s.cogLoadInstructions=t.cogLoadInstructions,s.recallInstructions=t.numberRecallInstructions};switch(e){case AssessmentEngine.Constants.blockTypes.EP1:s.instructions=t.enhanceNoLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.ep1Photos;break;case AssessmentEngine.Constants.blockTypes.EP2:s.instructions=t.enhanceCogLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.ep2Photos,n();break;case AssessmentEngine.Constants.blockTypes.EN1:s.instructions=t.enhanceNoLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.en1Photos;break;case AssessmentEngine.Constants.blockTypes.EN2:s.instructions=t.enhanceCogLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.en2Photos,n();break;case AssessmentEngine.Constants.blockTypes.SP1:s.instructions=t.suppressNoLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.sp1Photos;break;case AssessmentEngine.Constants.blockTypes.SP2:s.instructions=t.suppressCogLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.sp2Photos,n();break;case AssessmentEngine.Constants.blockTypes.SN1:s.instructions=t.suppressNoLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.sn1Photos;break;case AssessmentEngine.Constants.blockTypes.SN2:s.instructions=t.suppressCogLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.sn2Photos,n();break;case AssessmentEngine.Constants.blockTypes.VP1:s.instructions=t.viewNoLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.vp1Photos;break;case AssessmentEngine.Constants.blockTypes.VP2:s.instructions=t.viewCogLoadInstructions,s.emotionalIntensity=t.posRate,s.photos=t.vp2Photos,n();break;case AssessmentEngine.Constants.blockTypes.VN1:s.instructions=t.viewNoLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.vn1Photos;break;case AssessmentEngine.Constants.blockTypes.VN2:s.instructions=t.viewCogLoadInstructions,s.emotionalIntensity=t.negRate,s.photos=t.vn2Photos,n();break;default:throw new Error(`Block type ${e} is not supported`)}return s};const ManageParticipantView=function(e){const t=AssessmentEngine.Utility,s=new Vue({el:"#confirmationModal",data:{modalId:null,action:null,modalTitle:"",modalText:""},methods:{confirmAction:function(){if(this.modalId){switch(this.action){case"toggleLockout":const e=n.getParticipant(this.modalId);AssessmentEngine.HttpService.post("/Identity/Participant/ToggleLockout?userId="+this.modalId,()=>{e.enabled=!e.enabled});break;case"delete":AssessmentEngine.HttpService.post("/Identity/Participant/Delete?userId="+this.modalId,()=>{n.deleteParticipant(this.modalId)})}$("#confirmationModal").modal("hide")}},cancelAction:function(){this.modalId=null,this.action=null,this.modalTitle="",this.modalText=""}}}),n=new Vue({el:"#grid",data:function(){const s=t.buildSortMetadata(e.participants);return{sortKey:"",sortOrders:s.sortOrders,columns:s.columns,participants:e.participants.map(e=>({userId:e.userId,userName:e.userName,participantId:e.participantId,participantTypeId:e.participantTypeId,enabled:e.enabled,lastLoginDate:AssessmentEngine.Utility.formatDate(e.lastLoginDate),allowDelete:e.allowDelete}))}},computed:{sortedParticipants:function(){return t.sortGridData(this.participants,this.sortKey,this.sortOrders)}},methods:{sortBy:function(e){this.sortKey=e,this.sortOrders[e]=-1*this.sortOrders[e]},toggleLockout:function(e){s.action="toggleLockout",s.modalId=e,s.modalTitle="Confirm",s.modalText="Are you sure you want to update this participant?",$("#confirmationModal").modal("show")},confirmDelete:function(e){s.action="delete",s.modalId=e,s.modalTitle="Confirm Delete",s.modalText="Are you sure you want to delete this participant?",$("#confirmationModal").modal("show")},getParticipant:function(e){return this.participants.find(t=>t.userId===e)},deleteParticipant:function(e){const t=this.participants.findIndex(t=>t.userId===e);-1!==t&&this.participants.splice(t,1)}}});return setTimeout(t.toggleLoadingSpinner,150),{confirmationModal:s,grid:n}},TaskVersionView=function(e){const t=parseInt($("#TaskVersionId").val(),10);$((function(){$("#editTaskVersion").on("submit",n),$("#ParticipantUid").select2(),t>0&&$("#blockTypeContainer").show()}));const s=new Vue({el:"#blockGrid",data:{blockVersions:e.blockVersions.map(e=>({isEditing:!1,id:e.id,uid:e.uid,blockTypeId:e.blockTypeId,blockType:e.blockType.name,cognitiveLoad:e.cognitiveLoad,series:e.series,sortOrder:e.sortOrder}))},methods:{editRow:function(e){this.finishEdit();const t=this.getVersion(e);t&&(t.isEditing=!t.isEditing)},finishEdit:function(){this.blockVersions.forEach(e=>e.isEditing=!1)},toggleCheck:function(e,t){const s=this.getVersion(e);t.target.checked?this.setVersionSeries(s):s.series=null},setVersionSeries:function(e){AssessmentEngine.HttpService.get("/Tasks/TaskVersion/RandomSeries",t=>e.series=t)},getVersion:function(e){return this.blockVersions.find(t=>t.uid===e)}}}),n=function(e){e.preventDefault();const n=new AssessmentEngine.AjaxForm({sel:e.target}),i=n.serialize();i.blockVersions=t>0?s.blockVersions.map(e=>({Id:e.id,Uid:e.uid,CognitiveLoad:e.cognitiveLoad,Series:e.series,BlockTypeId:e.blockTypeId,sortOrder:e.sortOrder})):null,n.submit(i,e=>{0!==t?e.isValid?($(window).scrollTop(0),AssessmentEngine.Utility.alertMsg("#ajaxAlert","success","Task version saved successfully!")):AssessmentEngine.Utility.alertMsg("#ajaxAlert","danger","Please fix the following errors: "+e.errors.join(", ")):window.location.href="/Tasks/TaskVersion/Edit/"+e.data.taskVersionId})};return{blockGrid:s,submitForm:n}},TaskVersionsView=function(e){const t=AssessmentEngine.Utility;$((function(){$('[data-toggle="popover"]').popover()}));const s=new Vue({el:"#confirmationModal",data:{modalId:null,action:null,modalTitle:"",modalText:""},methods:{confirmAction:function(){if(this.modalId)switch(this.action){case"delete":AssessmentEngine.HttpService.post("/Tasks/TaskVersion/Delete/"+this.modalId,()=>{n.deleteVersion(this.modalId),$("#confirmationModal").modal("hide")})}},cancelAction:function(){this.modalId=null,this.action=null,this.modalTitle="",this.modalText=""}}}),n=new Vue({el:"#grid",data:function(){const s=t.buildSortMetadata(e);return{sortKey:"",sortOrders:s.sortOrders,columns:s.columns,versions:e.map(e=>({id:e.id,uid:e.uid,participantId:e.participantId,versionName:e.versionName,assessmentType:e.assessmentType,participantUrl:e.participantUrl,allowEdit:e.allowEdit,createdDate:AssessmentEngine.Utility.formatDate(e.createdDate)}))}},computed:{sortedVersions:function(){return t.sortGridData(this.versions,this.sortKey,this.sortOrders)}},methods:{sortBy:function(e){this.sortKey=e,this.sortOrders[e]=-1*this.sortOrders[e]},confirmDelete:function(e){s.modalId=e,s.action="delete",s.modalTitle="Confirm",s.modalText="Are you sure you want to delete this assessment version?",$("#confirmationModal").modal("show")},deleteVersion:function(e){const t=this.versions.findIndex(t=>t.id===e);-1!==t&&this.versions.splice(t,1)},copyLink:function(e){const t=this.versions.find(t=>t.id===e);navigator.permissions.query({name:"clipboard-write"}).then(e=>{"granted"!==e.state&&"prompt"!==e.state||navigator.clipboard.writeText(t.participantUrl).then((function(){}),(function(){console.error("Copy to clipboard failed")}))})}}});return setTimeout(t.toggleLoadingSpinner,150),{confirmationModal:s,grid:n}},EFTTask=function(e){const t=AssessmentEngine.HttpService,s=AssessmentEngine.Constants.blockDateTypes;let n=!1;$((function(){$(document).on("keypress",e=>{n||13===e.which&&l.participantTrigger()})})),setTimeout(AssessmentEngine.Utility.toggleLoadingSpinner,150);const i=AssessmentEngine.EftImageBuilder.build(e.blockType),o=void 0!==i.cogLoadInstructions,a=[i.intro,i.instructions,i.endScreen],r=[i.three,i.two,i.one],c=new Vue({el:"#confirmationModal",data:{modalId:null,action:null,modalTitle:"",modalText:""},methods:{confirmAction:function(){$("#confirmationModal").modal("hide")},cancelAction:function(){this.modalId=null,this.action=null,this.modalTitle="",this.modalText=""}}}),l=new Vue({el:"#eftView",data:function(){return{step:0,series:e.currentBlockVersion.series,seriesRecall:null,currentImageSrc:a[0],recallImageSrc:null,settings:e.settings,imgVisible:!0,seriesVisible:!1,recallVisible:!1,emotionVisible:!1,emotionImageSrc:null,emotionRating:null,blockComplete:!1}},methods:{participantTrigger:function(){this.step=this.step+1,this.step<2?this.currentImageSrc=this.getInstructionStepImage():o&&this.step<3?this.currentImageSrc=i.cogLoadInstructions:null===this.emotionRating?this.startTask():this.blockComplete&&this.loadNextVersion()},getInstructionStepImage:function(){const e=this.step<a.length?this.step:a.length-1;return a[e]},startTask:function(){const e=this;n=!0;const t=function(){let t=0;const s=setInterval((function(){e.currentImageSrc=r[t],e.imgVisible||(e.imgVisible=!0),t++,3===t&&(window.clearInterval(s),a())}),1e3)},a=function(){e.imgVisible||(e.imgVisible=!0),e.saveBlockDateTime(s.startTaskDateTime);let t,n=0,a=0,r=0;const c=e.settings.fixationCrossTimeSeconds+e.settings.imageViewTimeSeconds,l=1,g=2,m=function(){t=l,e.currentImageSrc=AssessmentEngine.Constants.eftImages.fixationCross};let d=!1;const p=setInterval((function(){0===n?m():t===l&&a===e.settings.fixationCrossTimeSeconds?d?(window.clearInterval(p),e.saveBlockDateTime(s.endTaskDateTime),e.showDataCollection(o)):(t=g,e.currentImageSrc=i.photos[r]):t===g&&a===c&&(m(),r++,a=0),a++,n++,5===r&&(d=!0)}),1e3)};o?function(){let s=0;e.imgVisible=!1,e.seriesVisible=!0;const n=setInterval((function(){s===e.settings.cognitiveLoadViewTimeSeconds&&(window.clearInterval(n),e.seriesVisible=!1,t()),s++}),1e3)}():t()},showDataCollection:function(e){e?this.showRecall():this.showEmotion()},showRecall:function(){this.imgVisible=!1,this.emotionVisible=!1,this.recallImageSrc=i.recallInstructions,this.recallVisible=!0},showEmotion:function(){this.imgVisible=!1,this.recallVisible=!1,this.emotionImageSrc=i.emotionalIntensity,this.emotionVisible=!0},submitRecall:function(s){s.preventDefault();const n=this;if(!(()=>{const e=parseInt(n.seriesRecall,10);return n.seriesRecall&&!Number.isNaN(e)})())return c.modalTitle="Validation error!",c.modalText="Please enter a number",void $("#confirmationModal").modal("show");n.$refs.submitSeriesBtn&&(n.$refs.submitSeriesBtn.disabled=!0);const i={blockVersionUid:e.currentBlockVersion.uid,seriesRecall:n.seriesRecall};t.postData("/Tasks/EFT/SeriesRecall",i,e=>{e.isValid?(n.$refs.submitSeriesBtn&&(n.$refs.submitSeriesBtn.disabled=!1),n.showEmotion()):console.log(e.errors)})},submitEmotion:function(s){s.preventDefault();const i=this;if(!(()=>{const e=parseInt(i.emotionRating,10);return i.emotionRating&&!Number.isNaN(e)&&e>0&&e<8})())return c.modalTitle="Validation error!",c.modalText="Please enter a number between 1 - 7",void $("#confirmationModal").modal("show");i.$refs.submitEmotionBtn&&(i.$refs.submitEmotionBtn.disabled=!0);const o={blockVersionUid:e.currentBlockVersion.uid,emotionRating:i.emotionRating};t.postData("/Tasks/EFT/EmotionRating",o,e=>{e.isValid?(i.recallVisible=!1,i.emotionVisible=!1,i.currentImageSrc=AssessmentEngine.Constants.eftImages.endScreen,i.imgVisible=!0,i.blockComplete=!0,i.$refs.submitEmotionBtn&&(i.$refs.submitEmotionBtn.disabled=!1),n=!1):console.log(e.errors)})},loadNextVersion:function(){window.location.href=`/Tasks/EFT/Index/${e.taskVersionUid}?blockVersion=${e.nextBlockVersion.blockTypeId}`},saveBlockDateTime:function(s){const n={blockVersionUid:e.currentBlockVersion.uid,blockDateType:s};t.postData("/Tasks/EFT/BlockDateTime",n,e=>{e&&e.isValid&&console.log("Block date time saved")})}}});return{eft:l}};